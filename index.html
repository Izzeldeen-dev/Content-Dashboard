<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Production Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        * { transition: background-color 0.2s, border-color 0.2s; }
        .row-urgent { background-color: #fee2e2 !important; }
        .row-urgent:hover { background-color: #fecaca !important; }
        .row-good { background-color: #d1fae5 !important; }
        .row-good:hover { background-color: #a7f3d0 !important; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #e2e8f0; }
        .sort-asc::after { content: " ▲"; }
        .sort-desc::after { content: " ▼"; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-slate-600">Loading Content Tracker...</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBwqkoiPx6nWU5Gv8WWc7P_Qu8_RsxhRF8",
            authDomain: "account-manager-dashboar-18a39.firebaseapp.com",
            databaseURL: "https://account-manager-dashboar-18a39-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "account-manager-dashboar-18a39",
            storageBucket: "account-manager-dashboar-18a39.firebasestorage.app",
            messagingSenderId: "494866550687",
            appId: "1:494866550687:web:efaa3ffb794748510877aa"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State
        let data = {
            managers: [],
            sessions: [],
            syncing: false,
            addingSession: false,
            searchQuery: '',
            editingClientId: null,
            statusFilter: 'all', // all, urgent, good
            sortBy: null,
            sortDir: 'asc',
            showCalendar: false,
            showCalculator: false
        };

        let isDrawing = false;
        let coverageChart = null;

        // Save
        function save() {
            data.syncing = true;
            updateSyncStatus();
            db.ref('sessions').set(data.sessions).then(() => {
                setTimeout(() => { data.syncing = false; updateSyncStatus(); }, 500);
            });
        }

        function updateSyncStatus() {
            const el = document.getElementById('sync-status');
            if (el) {
                el.innerHTML = data.syncing ? 
                    '<div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div><span class="text-blue-600 font-medium">Syncing...</span>' :
                    '<svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span class="text-emerald-600 font-medium">Saved</span>';
            }
        }

        // Load Data
        Promise.all([
            db.ref('managers').once('value'),
            db.ref('sessions').once('value')
        ]).then(([managersSnap, sessionsSnap]) => {
            if (managersSnap.exists()) {
                let managersData = managersSnap.val();
                if (!Array.isArray(managersData)) {
                    managersData = Object.values(managersData);
                }
                data.managers = managersData;
            }

            if (sessionsSnap.exists()) {
                let sessionsData = sessionsSnap.val();
                if (!Array.isArray(sessionsData)) {
                    sessionsData = Object.values(sessionsData);
                }
                data.sessions = sessionsData;
            } else {
                data.sessions = [];
            }

            draw();
        }).catch(err => {
            alert('Error loading: ' + err.message);
        });

        // Get all unique clients from managers
        function getAllClients() {
            const clients = [];
            data.managers.forEach(mgr => {
                if (mgr.clients && Array.isArray(mgr.clients)) {
                    mgr.clients.forEach(client => {
                        clients.push({
                            id: client.id,
                            name: client.name,
                            managerName: mgr.name,
                            managerId: mgr.id,
                            videosPerDay: client.videosPerDay || 6
                        });
                    });
                }
            });
            return clients;
        }

        function calculateSessionVideos(durationMinutes) {
            return Math.floor(durationMinutes / 10) * 4;
        }

        function getClientStats(clientId) {
            const client = getAllClients().find(c => c.id === clientId);
            const videosPerDay = client ? client.videosPerDay : 6;
            
            const clientSessions = data.sessions.filter(s => s.clientId === clientId && s.materialReceived);
            const totalVideos = clientSessions.reduce((sum, s) => sum + calculateSessionVideos(s.duration), 0);
            const coverageDays = Math.floor(totalVideos / videosPerDay);
            
            // Find the most recent session date (when material was received)
            let latestSessionDate = new Date();
            latestSessionDate.setHours(0, 0, 0, 0);
            
            if (clientSessions.length > 0) {
                const sessionDates = clientSessions.map(s => new Date(s.date));
                latestSessionDate = new Date(Math.max(...sessionDates));
                latestSessionDate.setHours(0, 0, 0, 0);
            }
            
            // Calculate coverage until: Latest session date + 3 days production + coverage days
            const coverageUntil = new Date(latestSessionDate);
            coverageUntil.setDate(coverageUntil.getDate() + 3 + coverageDays);
            
            return {
                sessionCount: clientSessions.length,
                totalVideos,
                coverageDays,
                videosPerDay,
                latestSessionDate: latestSessionDate.toLocaleDateString(),
                coverageUntil: coverageUntil.toLocaleDateString(),
                coverageUntilDate: coverageUntil,
                isLowCoverage: coverageDays < 5
            };
        }

        // Actions
        function showAddSession() {
            data.addingSession = true;
            draw();
        }

        function cancelAddSession() {
            data.addingSession = false;
            draw();
        }

        function addSession() {
            const clientId = parseInt(document.getElementById('session-client').value);
            const date = document.getElementById('session-date').value;
            const duration = parseInt(document.getElementById('session-duration').value);
            const materialReceived = document.getElementById('session-material').checked;

            if (!clientId || !date || !duration) {
                alert('Please fill all fields');
                return;
            }

            data.sessions.push({
                id: Date.now(),
                clientId,
                date,
                duration,
                materialReceived
            });

            data.addingSession = false;
            draw();
            save();
        }

        function toggleMaterial(sessionId) {
            const session = data.sessions.find(s => s.id === sessionId);
            if (session) {
                session.materialReceived = !session.materialReceived;
                draw();
                save();
            }
        }

        function deleteSession(sessionId) {
            if (!confirm('Delete this session?')) return;
            data.sessions = data.sessions.filter(s => s.id !== sessionId);
            draw();
            save();
        }

        function updateSearch(val) {
            data.searchQuery = val.toLowerCase();
            draw();
        }

        function setStatusFilter(filter) {
            data.statusFilter = filter;
            draw();
        }

        function sortBy(field) {
            if (data.sortBy === field) {
                data.sortDir = data.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                data.sortBy = field;
                data.sortDir = 'asc';
            }
            draw();
        }

        function startEditVideosPerDay(clientId) {
            data.editingClientId = clientId;
            draw();
        }

        function cancelEditVideosPerDay() {
            data.editingClientId = null;
            draw();
        }

        function saveVideosPerDay(clientId) {
            const input = document.getElementById(`vpd-${clientId}`);
            const newValue = parseInt(input.value);
            
            if (!newValue || newValue < 1) {
                alert('Please enter a valid number');
                return;
            }

            let updated = false;
            data.managers.forEach(mgr => {
                if (mgr.clients && Array.isArray(mgr.clients)) {
                    const client = mgr.clients.find(c => c.id === clientId);
                    if (client) {
                        client.videosPerDay = newValue;
                        updated = true;
                    }
                }
            });

            if (updated) {
                data.editingClientId = null;
                db.ref('managers').set(data.managers).then(() => {
                    draw();
                });
            }
        }

        function toggleCalendar() {
            data.showCalendar = !data.showCalendar;
            draw();
        }

        function toggleCalculator() {
            data.showCalculator = !data.showCalculator;
            draw();
        }

        function calculateCoverage() {
            const clientSelect = document.getElementById('calc-client');
            const durationInput = document.getElementById('calc-duration');
            
            if (!clientSelect || !durationInput) return;
            
            const clientId = parseInt(clientSelect.value);
            const duration = parseInt(durationInput.value);
            
            if (!clientId || !duration) {
                document.getElementById('calc-result').innerHTML = '<p class="text-slate-500">Please select a client and enter duration</p>';
                return;
            }
            
            const client = getAllClients().find(c => c.id === clientId);
            if (!client) return;
            
            const stats = getClientStats(clientId);
            const newVideos = calculateSessionVideos(duration);
            const totalVideosAfter = stats.totalVideos + newVideos;
            const newCoverageDays = Math.floor(totalVideosAfter / stats.videosPerDay);
            
            // If filming today, session date = today
            // Coverage until = today + 3 days production + new total coverage days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const readyDate = new Date(today);
            readyDate.setDate(readyDate.getDate() + 3);
            
            const newCoverageUntil = new Date(today);
            newCoverageUntil.setDate(newCoverageUntil.getDate() + 3 + newCoverageDays);
            
            document.getElementById('calc-result').innerHTML = `
                <div class="bg-purple-50 rounded-lg p-4 border-2 border-purple-200">
                    <h4 class="font-bold text-purple-900 mb-3">If you film today:</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-700">Session Date:</span>
                            <span class="font-bold text-slate-900">${today.toLocaleDateString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-700">New Videos:</span>
                            <span class="font-bold text-slate-900">+${newVideos} videos</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-700">Production Time:</span>
                            <span class="font-medium text-slate-900">3 days</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-700">Ready to Post:</span>
                            <span class="font-medium text-slate-900">${readyDate.toLocaleDateString()}</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="text-slate-700">Current Coverage:</span>
                            <span class="font-medium text-slate-900">${stats.coverageDays} days (until ${stats.coverageUntil})</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-700">New Total Coverage:</span>
                            <span class="font-bold text-purple-600 text-lg">${newCoverageDays} days</span>
                        </div>
                        <div class="flex justify-between border-t pt-2 bg-white rounded p-2">
                            <span class="text-slate-700 font-bold">Coverage Until:</span>
                            <span class="font-bold text-purple-600 text-lg">${newCoverageUntil.toLocaleDateString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-700">Extension:</span>
                            <span class="font-bold text-emerald-600 text-lg">+${newCoverageDays - stats.coverageDays} days</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get filming deadline for client
        function getFilmingDeadline(clientId) {
            const stats = getClientStats(clientId);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Coverage runs out on coverageUntilDate
            // We want 5-day buffer, so film when: (coverageUntilDate - today) <= 5 + 3
            // The +3 is because filming today takes 3 days to produce
            const daysUntilCoverageEnds = Math.floor((stats.coverageUntilDate - today) / (1000 * 60 * 60 * 24));
            const daysUntilFilm = daysUntilCoverageEnds - 8; // 5 day buffer + 3 day production
            
            const filmBy = new Date(today);
            filmBy.setDate(filmBy.getDate() + Math.max(0, daysUntilFilm));
            
            return {
                filmBy: filmBy.toLocaleDateString(),
                daysLeft: Math.max(0, daysUntilFilm),
                isUrgent: daysUntilFilm <= 0,
                isWarning: daysUntilFilm > 0 && daysUntilFilm <= 3
            };
        }

        // Filter clients
        function filterClients(clients) {
            let filtered = clients;
            
            // Search filter
            if (data.searchQuery) {
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(data.searchQuery) ||
                    c.managerName.toLowerCase().includes(data.searchQuery)
                );
            }

            // Status filter
            if (data.statusFilter !== 'all') {
                filtered = filtered.filter(c => {
                    const stats = getClientStats(c.id);
                    if (data.statusFilter === 'urgent') return stats.isLowCoverage;
                    if (data.statusFilter === 'good') return !stats.isLowCoverage;
                    return true;
                });
            }

            // Sort
            if (data.sortBy) {
                filtered.sort((a, b) => {
                    const statsA = getClientStats(a.id);
                    const statsB = getClientStats(b.id);
                    
                    let valA, valB;
                    switch(data.sortBy) {
                        case 'name': valA = a.name; valB = b.name; break;
                        case 'manager': valA = a.managerName; valB = b.managerName; break;
                        case 'sessions': valA = statsA.sessionCount; valB = statsB.sessionCount; break;
                        case 'videos': valA = statsA.totalVideos; valB = statsB.totalVideos; break;
                        case 'coverage': valA = statsA.coverageDays; valB = statsB.coverageDays; break;
                        case 'until': valA = statsA.coverageUntilDate; valB = statsB.coverageUntilDate; break;
                        default: return 0;
                    }
                    
                    if (valA < valB) return data.sortDir === 'asc' ? -1 : 1;
                    if (valA > valB) return data.sortDir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            return filtered;
        }

        // Draw coverage chart
        function drawChart(clients) {
            const ctx = document.getElementById('coverageChart');
            if (!ctx) return;

            const chartData = clients.slice(0, 10).map(client => {
                const stats = getClientStats(client.id);
                return {
                    name: client.name,
                    coverage: stats.coverageDays,
                    isLow: stats.isLowCoverage
                };
            });

            if (coverageChart) {
                coverageChart.destroy();
            }

            coverageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets: [{
                        label: 'Coverage Days',
                        data: chartData.map(d => d.coverage),
                        backgroundColor: chartData.map(d => d.isLow ? '#ef4444' : '#10b981'),
                        borderColor: chartData.map(d => d.isLow ? '#dc2626' : '#059669'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.y} days coverage`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e2e8f0' },
                            ticks: { color: '#64748b' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b' }
                        }
                    }
                }
            });
        }

        // Draw UI
        function draw() {
            if (isDrawing) return;
            isDrawing = true;

            const allClients = getAllClients();
            const filtered = filterClients(allClients);

            const totalSessions = data.sessions.length;
            const totalMaterialReceived = data.sessions.filter(s => s.materialReceived).length;
            const urgentClients = allClients.filter(c => getClientStats(c.id).isLowCoverage);

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 via-purple-50 to-slate-100">
                    <!-- Header -->
                    <div class="bg-white border-b border-slate-200 shadow-sm">
                        <div class="max-w-7xl mx-auto px-8 py-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-bold text-slate-900">Content Production Tracker</h1>
                                    <p class="text-slate-600 mt-1">Track filming sessions & content coverage</p>
                                </div>
                                <div id="sync-status" class="flex items-center gap-2 text-sm">
                                    <span class="text-emerald-600 font-medium">Loaded</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto px-8 py-8">
                        <!-- Stats Overview -->
                        <div class="grid grid-cols-4 gap-4 mb-8">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                                <div class="text-sm font-medium text-slate-600 mb-1">Total Clients</div>
                                <div class="text-3xl font-bold text-slate-900">${allClients.length}</div>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                                <div class="text-sm font-medium text-slate-600 mb-1">Total Sessions</div>
                                <div class="text-3xl font-bold text-slate-900">${totalSessions}</div>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                                <div class="text-sm font-medium text-slate-600 mb-1">Material Received</div>
                                <div class="text-3xl font-bold text-emerald-600">${totalMaterialReceived}</div>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                                <div class="text-sm font-medium text-slate-600 mb-1">Low Coverage Alerts</div>
                                <div class="text-3xl font-bold ${urgentClients.length > 0 ? 'text-red-600' : 'text-emerald-600'}">${urgentClients.length}</div>
                            </div>
                        </div>

                        <!-- Quick Tools -->
                        <div class="grid grid-cols-2 gap-4 mb-8">
                            <button onclick="toggleCalendar()" class="bg-white rounded-xl shadow-sm p-6 border-2 ${data.showCalendar ? 'border-purple-500 bg-purple-50' : 'border-slate-200 hover:border-purple-300'} text-left transition-all">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <h3 class="text-lg font-bold text-slate-900">Calendar View</h3>
                                </div>
                                <p class="text-sm text-slate-600">See all filming sessions on a calendar</p>
                            </button>
                            <button onclick="toggleCalculator()" class="bg-white rounded-xl shadow-sm p-6 border-2 ${data.showCalculator ? 'border-purple-500 bg-purple-50' : 'border-slate-200 hover:border-purple-300'} text-left transition-all">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    <h3 class="text-lg font-bold text-slate-900">Coverage Calculator</h3>
                                </div>
                                <p class="text-sm text-slate-600">Calculate coverage from filming duration</p>
                            </button>
                        </div>

                        <!-- Calendar View -->
                        ${data.showCalendar ? `
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200 mb-8">
                                <h2 class="text-xl font-bold text-slate-900 mb-4">Filming Sessions Calendar</h2>
                                ${(() => {
                                    const sessionsWithClients = data.sessions.map(s => {
                                        const client = allClients.find(c => c.id === s.clientId);
                                        return { ...s, clientName: client ? client.name : 'Unknown' };
                                    }).sort((a, b) => new Date(b.date) - new Date(a.date));
                                    
                                    if (sessionsWithClients.length === 0) {
                                        return '<p class="text-slate-500 text-center py-8">No sessions recorded yet</p>';
                                    }
                                    
                                    return `
                                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            ${sessionsWithClients.map(s => {
                                                const videos = calculateSessionVideos(s.duration);
                                                return `
                                                    <div class="bg-slate-50 rounded-lg p-4 border ${s.materialReceived ? 'border-emerald-300 bg-emerald-50' : 'border-slate-200'}">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                                            <span class="font-bold text-slate-900">${new Date(s.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                                        </div>
                                                        <div class="font-semibold text-slate-900 mb-1">${s.clientName}</div>
                                                        <div class="text-sm text-slate-600 mb-2">${s.duration} min • ${videos} videos</div>
                                                        <div class="flex items-center gap-2">
                                                            ${s.materialReceived ? 
                                                                '<span class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded font-medium">✓ Material Received</span>' :
                                                                '<span class="text-xs px-2 py-1 bg-amber-100 text-amber-700 rounded font-medium">⏳ Pending</span>'
                                                            }
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    `;
                                })()}
                            </div>
                        ` : ''}

                        <!-- Coverage Calculator -->
                        ${data.showCalculator ? `
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200 mb-8">
                                <h2 class="text-xl font-bold text-slate-900 mb-4">Coverage Calculator</h2>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">Select Client</label>
                                            <select id="calc-client" onchange="calculateCoverage()" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                                <option value="">Choose a client...</option>
                                                ${allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">Filming Duration (minutes)</label>
                                            <input type="number" id="calc-duration" placeholder="120" oninput="calculateCoverage()" 
                                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        </div>
                                        <div class="bg-blue-50 rounded-lg p-4 text-sm text-blue-800">
                                            <strong>Formula:</strong> Every 10 minutes = 4 videos<br>
                                            Videos ÷ Videos per day = Coverage days
                                        </div>
                                    </div>
                                    <div id="calc-result">
                                        <p class="text-slate-500 text-center py-12">Select a client and enter duration to see results</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Auto-Schedule Suggestions -->
                        ${(() => {
                            const needFilming = allClients.map(c => ({
                                ...c,
                                deadline: getFilmingDeadline(c.id),
                                stats: getClientStats(c.id)
                            })).filter(c => c.deadline.isUrgent || c.deadline.isWarning)
                               .sort((a, b) => a.deadline.daysLeft - b.deadline.daysLeft);
                            
                            if (needFilming.length === 0) return '';
                            
                            return `
                                <div class="bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl p-6 mb-8">
                                    <div class="flex items-center gap-3 mb-4">
                                        <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <h2 class="text-2xl font-bold text-orange-900">Filming Schedule Recommendations</h2>
                                    </div>
                                    <p class="text-orange-800 mb-4">To maintain 5-day coverage buffer, film these clients soon:</p>
                                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${needFilming.map(c => `
                                            <div class="bg-white rounded-lg p-4 border-2 ${c.deadline.isUrgent ? 'border-red-300' : 'border-orange-300'}">
                                                <div class="flex items-start justify-between mb-2">
                                                    <div>
                                                        <div class="font-bold text-lg text-slate-900">${c.name}</div>
                                                        <div class="text-sm text-slate-600">${c.managerName}</div>
                                                    </div>
                                                    ${c.deadline.isUrgent ? 
                                                        '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded">URGENT</span>' :
                                                        '<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded">SOON</span>'
                                                    }
                                                </div>
                                                <div class="text-sm space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-slate-600">Current Coverage:</span>
                                                        <span class="font-bold">${c.stats.coverageDays} days</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-slate-600">Days Until Film:</span>
                                                        <span class="font-bold ${c.deadline.isUrgent ? 'text-red-600' : 'text-orange-600'}">${c.deadline.daysLeft} days</span>
                                                    </div>
                                                    <div class="pt-2 border-t">
                                                        <div class="font-bold ${c.deadline.isUrgent ? 'text-red-600' : 'text-orange-600'}">
                                                            ${c.deadline.isUrgent ? '🚨 Film NOW!' : `📅 Film by ${c.deadline.filmBy}`}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        })()}

                        <!-- Alerts Dashboard -->
                        ${urgentClients.length > 0 ? `
                            <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-8">
                                <div class="flex items-center gap-3 mb-4">
                                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    <h2 class="text-2xl font-bold text-red-900">Urgent: ${urgentClients.length} Client${urgentClients.length > 1 ? 's' : ''} Running Low!</h2>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4">
                                    ${urgentClients.map(client => {
                                        const stats = getClientStats(client.id);
                                        return `
                                            <div class="bg-white rounded-lg p-4 border-2 border-red-300">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div class="font-bold text-lg text-slate-900">${client.name}</div>
                                                        <div class="text-sm text-slate-600">${client.managerName}</div>
                                                    </div>
                                                    <div class="text-right">
                                                        <div class="text-2xl font-bold text-red-600">${stats.coverageDays}</div>
                                                        <div class="text-xs text-slate-600">days left</div>
                                                    </div>
                                                </div>
                                                <div class="text-sm text-red-700 font-medium">⚠️ Coverage ends: ${stats.coverageUntil}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- ONE Unified Action Required Table -->
                        ${(() => {
                            // Get all clients that need attention (urgent OR need filming soon)
                            const actionRequired = allClients.map(c => {
                                const stats = getClientStats(c.id);
                                const deadline = getFilmingDeadline(c.id);
                                return {
                                    ...c,
                                    stats,
                                    deadline,
                                    needsAction: stats.isLowCoverage || deadline.isUrgent || deadline.isWarning
                                };
                            }).filter(c => c.needsAction)
                               .sort((a, b) => {
                                   // Sort by urgency: urgent coverage first, then by days left
                                   if (a.stats.isLowCoverage && !b.stats.isLowCoverage) return -1;
                                   if (!a.stats.isLowCoverage && b.stats.isLowCoverage) return 1;
                                   return a.stats.coverageDays - b.stats.coverageDays;
                               });
                            
                            if (actionRequired.length === 0) return '';
                            
                            const urgentCount = actionRequired.filter(c => c.stats.isLowCoverage || c.deadline.isUrgent).length;
                            const soonCount = actionRequired.length - urgentCount;
                            
                            return `
                                <div class="bg-white rounded-xl shadow-lg border-2 border-red-200 overflow-hidden mb-8">
                                    <div class="bg-gradient-to-r from-red-500 to-orange-500 text-white p-6">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                                <div>
                                                    <h2 class="text-2xl font-bold">⚠️ Action Required: ${actionRequired.length} Client${actionRequired.length > 1 ? 's' : ''}</h2>
                                                    <p class="text-white/90 mt-1">
                                                        ${urgentCount > 0 ? `🔴 ${urgentCount} Urgent` : ''} 
                                                        ${urgentCount > 0 && soonCount > 0 ? ' • ' : ''}
                                                        ${soonCount > 0 ? `🟠 ${soonCount} Need Filming Soon` : ''}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-slate-50 border-b-2 border-slate-200">
                                                <tr>
                                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Priority</th>
                                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Client</th>
                                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Manager</th>
                                                    <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase">Coverage</th>
                                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Coverage Until</th>
                                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Film By</th>
                                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Reason</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200">
                                                ${actionRequired.map(client => {
                                                    const isUrgent = client.stats.isLowCoverage || client.deadline.isUrgent;
                                                    const priorityLabel = isUrgent ? 'URGENT' : 'SOON';
                                                    const rowClass = isUrgent ? 'bg-red-50' : 'bg-orange-50';
                                                    
                                                    return `
                                                        <tr class="${rowClass} hover:opacity-90">
                                                            <td class="px-6 py-4">
                                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${isUrgent ? 'bg-red-600 text-white' : 'bg-orange-500 text-white'}">
                                                                    ${isUrgent ? '🔴' : '🟠'} ${priorityLabel}
                                                                </span>
                                                            </td>
                                                            <td class="px-6 py-4">
                                                                <div class="font-bold text-slate-900">${client.name}</div>
                                                                <button onclick="viewClientDetails(${client.id})" class="text-xs text-purple-600 hover:text-purple-800 mt-1">
                                                                    View Details
                                                                </button>
                                                            </td>
                                                            <td class="px-6 py-4 text-slate-700">${client.managerName}</td>
                                                            <td class="px-6 py-4 text-center">
                                                                <div class="font-bold text-2xl ${client.stats.isLowCoverage ? 'text-red-600' : 'text-orange-600'}">
                                                                    ${client.stats.coverageDays}
                                                                </div>
                                                                <div class="text-xs text-slate-600">days</div>
                                                            </td>
                                                            <td class="px-6 py-4">
                                                                <div class="font-semibold text-slate-900">${client.stats.coverageUntil}</div>
                                                            </td>
                                                            <td class="px-6 py-4">
                                                                <div class="font-bold ${isUrgent ? 'text-red-600' : 'text-orange-600'}">
                                                                    ${client.deadline.isUrgent ? '🚨 NOW!' : client.deadline.filmBy}
                                                                </div>
                                                                ${!client.deadline.isUrgent ? `<div class="text-xs text-slate-600 mt-1">${client.deadline.daysLeft} days</div>` : ''}
                                                            </td>
                                                            <td class="px-6 py-4">
                                                                ${client.stats.isLowCoverage ? 
                                                                    '<div class="text-sm font-medium text-red-700">⚠️ Low coverage (<5 days)</div>' :
                                                                    '<div class="text-sm font-medium text-orange-700">📅 Film soon to maintain buffer</div>'
                                                                }
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        })()}

                        <!-- Coverage Chart -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200 mb-8">
                            <h2 class="text-xl font-bold text-slate-900 mb-4">Coverage Overview (Top 10 Clients)</h2>
                            <div style="height: 300px;">
                                <canvas id="coverageChart"></canvas>
                            </div>
                        </div>

                        <!-- Search & Filters -->
                        <div class="flex gap-4 mb-6">
                            <input type="text" placeholder="Search clients or managers..." 
                                oninput="updateSearch(this.value)" value="${data.searchQuery}"
                                class="flex-1 px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            
                            <div class="flex gap-2">
                                <button onclick="setStatusFilter('all')" 
                                    class="px-4 py-3 rounded-lg font-medium ${data.statusFilter === 'all' ? 'bg-purple-600 text-white' : 'bg-white border border-slate-300 text-slate-700 hover:bg-slate-50'}">
                                    All (${allClients.length})
                                </button>
                                <button onclick="setStatusFilter('urgent')" 
                                    class="px-4 py-3 rounded-lg font-medium ${data.statusFilter === 'urgent' ? 'bg-red-600 text-white' : 'bg-white border border-slate-300 text-slate-700 hover:bg-slate-50'}">
                                    Urgent (${urgentClients.length})
                                </button>
                                <button onclick="setStatusFilter('good')" 
                                    class="px-4 py-3 rounded-lg font-medium ${data.statusFilter === 'good' ? 'bg-emerald-600 text-white' : 'bg-white border border-slate-300 text-slate-700 hover:bg-slate-50'}">
                                    Good (${allClients.length - urgentClients.length})
                                </button>
                            </div>

                            <button onclick="showAddSession()"
                                class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                Add Session
                            </button>
                        </div>

                        <!-- Add Session Form -->
                        ${data.addingSession ? `
                            <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-2 border-purple-200 fade-in">
                                <h3 class="text-lg font-bold text-slate-900 mb-4">Add New Session</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Client</label>
                                        <select id="session-client" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                            <option value="">Select client...</option>
                                            ${allClients.map(c => `<option value="${c.id}">${c.name} (${c.managerName})</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Date Filmed</label>
                                        <input type="date" id="session-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Duration (minutes)</label>
                                        <input type="number" id="session-duration" placeholder="120" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="session-material" class="w-5 h-5 text-purple-600 rounded">
                                            <span class="text-sm font-medium text-slate-700">Material Received</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button onclick="addSession()" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-medium">
                                        Add Session
                                    </button>
                                    <button onclick="cancelAddSession()" class="px-6 py-3 border border-slate-300 rounded-lg hover:bg-slate-100">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Clients Table -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th onclick="sortBy('name')" class="sortable px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider ${data.sortBy === 'name' ? (data.sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">Client</th>
                                            <th onclick="sortBy('manager')" class="sortable px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider ${data.sortBy === 'manager' ? (data.sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">Manager</th>
                                            <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Videos/Day</th>
                                            <th onclick="sortBy('sessions')" class="sortable px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider ${data.sortBy === 'sessions' ? (data.sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">Sessions</th>
                                            <th onclick="sortBy('videos')" class="sortable px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider ${data.sortBy === 'videos' ? (data.sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">Videos</th>
                                            <th onclick="sortBy('coverage')" class="sortable px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider ${data.sortBy === 'coverage' ? (data.sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">Coverage</th>
                                            <th onclick="sortBy('until')" class="sortable px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider ${data.sortBy === 'until' ? (data.sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">Until</th>
                                            <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200">
                                        ${filtered.length === 0 ? 
                                            '<tr><td colspan="9" class="px-6 py-12 text-center text-slate-500">No clients found</td></tr>' :
                                            filtered.map(client => {
                                                const stats = getClientStats(client.id);
                                                const sessions = data.sessions.filter(s => s.clientId === client.id);
                                                const rowClass = stats.isLowCoverage ? 'row-urgent' : 'row-good';
                                                
                                                return `
                                                    <tr class="${rowClass} fade-in">
                                                        <td class="px-6 py-4">
                                                            <div class="font-semibold text-slate-900">${client.name}</div>
                                                            <button onclick="viewClientDetails(${client.id})" class="text-xs text-purple-600 hover:text-purple-800 mt-1">
                                                                View Sessions (${sessions.length})
                                                            </button>
                                                        </td>
                                                        <td class="px-6 py-4 text-slate-700">${client.managerName}</td>
                                                        <td class="px-6 py-4 text-center">
                                                            ${data.editingClientId === client.id ? `
                                                                <div class="flex items-center justify-center gap-2">
                                                                    <input type="number" id="vpd-${client.id}" value="${stats.videosPerDay}" 
                                                                        class="w-16 px-2 py-1 border border-purple-300 rounded text-center focus:ring-2 focus:ring-purple-500">
                                                                    <button onclick="saveVideosPerDay(${client.id})" 
                                                                        class="p-1 text-green-600 hover:bg-green-50 rounded" title="Save">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                                    </button>
                                                                    <button onclick="cancelEditVideosPerDay()" 
                                                                        class="p-1 text-red-600 hover:bg-red-50 rounded" title="Cancel">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                                    </button>
                                                                </div>
                                                            ` : `
                                                                <div class="flex items-center justify-center gap-2">
                                                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                                                                        ${stats.videosPerDay}
                                                                    </span>
                                                                    <button onclick="startEditVideosPerDay(${client.id})" 
                                                                        class="p-1 text-purple-600 hover:bg-purple-50 rounded" title="Edit">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                                                    </button>
                                                                </div>
                                                            `}
                                                        </td>
                                                        <td class="px-6 py-4 text-center">
                                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-slate-100 text-slate-800">
                                                                ${stats.sessionCount}
                                                            </span>
                                                        </td>
                                                        <td class="px-6 py-4 text-center">
                                                            <span class="text-lg font-bold text-slate-900">${stats.totalVideos}</span>
                                                        </td>
                                                        <td class="px-6 py-4">
                                                            <div class="flex flex-col gap-1">
                                                                <span class="text-lg font-bold ${stats.isLowCoverage ? 'text-red-600' : 'text-emerald-600'}">
                                                                    ${stats.coverageDays} days
                                                                </span>
                                                                <div class="w-full bg-slate-200 rounded-full h-2">
                                                                    <div class="${stats.isLowCoverage ? 'bg-red-500' : 'bg-emerald-500'} h-2 rounded-full" 
                                                                        style="width: ${Math.min(stats.coverageDays * 10, 100)}%"></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="px-6 py-4 text-slate-700">${stats.coverageUntil}</td>
                                                        <td class="px-6 py-4 text-center">
                                                            ${stats.isLowCoverage ? 
                                                                '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800">🔴 URGENT</span>' :
                                                                '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-800">✓ Good</span>'
                                                            }
                                                        </td>
                                                        <td class="px-6 py-4 text-center">
                                                            <button onclick="viewClientDetails(${client.id})" 
                                                                class="text-purple-600 hover:text-purple-800 font-medium text-sm">
                                                                Details
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            isDrawing = false;
            
            // Draw chart after DOM update
            setTimeout(() => drawChart(filtered), 100);
        }

        // View client details
        function viewClientDetails(clientId) {
            const client = getAllClients().find(c => c.id === clientId);
            if (!client) return;

            const sessions = data.sessions.filter(s => s.clientId === clientId);
            const stats = getClientStats(clientId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">${client.name}</h2>
                                <p class="text-slate-600 mt-1">Account Manager: ${client.managerName}</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-5 gap-4 mb-6">
                            <div class="bg-slate-50 rounded-lg p-4">
                                <div class="text-xs font-medium text-slate-600 mb-1">Videos/Day</div>
                                <div class="text-2xl font-bold text-purple-600">${stats.videosPerDay}</div>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-4">
                                <div class="text-xs font-medium text-slate-600 mb-1">Sessions</div>
                                <div class="text-2xl font-bold text-slate-900">${stats.sessionCount}</div>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-4">
                                <div class="text-xs font-medium text-slate-600 mb-1">Total Videos</div>
                                <div class="text-2xl font-bold text-slate-900">${stats.totalVideos}</div>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-4">
                                <div class="text-xs font-medium text-slate-600 mb-1">Coverage</div>
                                <div class="text-2xl font-bold ${stats.isLowCoverage ? 'text-red-600' : 'text-emerald-600'}">${stats.coverageDays} days</div>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-4">
                                <div class="text-xs font-medium text-slate-600 mb-1">Until</div>
                                <div class="text-lg font-bold text-slate-900">${stats.coverageUntil}</div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-4 mb-6 text-sm">
                            <strong>Calculation:</strong> Latest session (${stats.latestSessionDate}) + 3 days production + ${stats.coverageDays} days coverage = ${stats.coverageUntil}
                        </div>

                        <!-- Sessions List -->
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Sessions</h3>
                        <div class="space-y-3">
                            ${sessions.length === 0 ? 
                                '<p class="text-slate-500 text-center py-8">No sessions recorded</p>' :
                                sessions.map(session => {
                                    const videos = calculateSessionVideos(session.duration);
                                    return `
                                        <div class="bg-slate-50 rounded-lg p-4 flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <span class="font-semibold text-slate-900">${new Date(session.date).toLocaleDateString()}</span>
                                                    <span class="text-sm text-slate-600">${session.duration} min</span>
                                                    <span class="text-sm font-medium text-purple-600">${videos} videos</span>
                                                </div>
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${session.materialReceived ? 'checked' : ''} 
                                                        onchange="toggleMaterial(${session.id}); setTimeout(() => this.closest('.fixed').remove(), 100);"
                                                        class="w-4 h-4 text-purple-600 rounded">
                                                    <span class="text-sm text-slate-600">Material Received</span>
                                                </label>
                                            </div>
                                            <button onclick="deleteSession(${session.id}); this.closest('.fixed').remove();" 
                                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
